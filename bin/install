#!/usr/bin/env bash
set -euo pipefail

# Skills Installer
# Symlinks skills from this repo to ~/.claude/skills/

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SKILLS_SOURCE="$SCRIPT_DIR/.claude/skills"
SKILLS_TARGET="$HOME/.claude/skills"
AGENTS_SOURCE="$SCRIPT_DIR/.claude/agents"
AGENTS_TARGET="$HOME/.claude/agents"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

CLAUDE_MD_SOURCE="$SCRIPT_DIR/CLAUDE.md"
CLAUDE_MD_TARGET="$HOME/.claude/CLAUDE.md"

echo -e "${BLUE}Installing skills from $SKILLS_SOURCE${NC}"

# Create target directory if it doesn't exist
mkdir -p "$SKILLS_TARGET"

# Symlink CLAUDE.md
if [[ -f "$CLAUDE_MD_SOURCE" ]]; then
    if [[ -L "$CLAUDE_MD_TARGET" ]]; then
        current_target="$(readlink "$CLAUDE_MD_TARGET")"
        if [[ "$current_target" == "$CLAUDE_MD_SOURCE" ]]; then
            echo -e "  ${YELLOW}⊘${NC} CLAUDE.md (already linked)"
        else
            echo -e "  ${YELLOW}⚠${NC} CLAUDE.md exists but points elsewhere: $current_target"
        fi
    elif [[ -f "$CLAUDE_MD_TARGET" ]]; then
        echo -e "  ${YELLOW}⚠${NC} CLAUDE.md exists as file (skipping)"
    else
        ln -s "$CLAUDE_MD_SOURCE" "$CLAUDE_MD_TARGET"
        echo -e "  ${GREEN}✓${NC} CLAUDE.md"
    fi
fi

# Get list of skills
skills=($(ls -d "$SKILLS_SOURCE"/*/ 2>/dev/null | xargs -n1 basename))

if [[ ${#skills[@]} -eq 0 ]]; then
    echo "No skills found in $SKILLS_SOURCE"
    exit 1
fi

installed=0
skipped=0

for skill in "${skills[@]}"; do
    source_path="$SKILLS_SOURCE/$skill"
    target_path="$SKILLS_TARGET/$skill"

    if [[ -L "$target_path" ]]; then
        # Already a symlink - check if it points to our source
        current_target="$(readlink "$target_path")"
        if [[ "$current_target" == "$source_path" ]]; then
            echo -e "  ${YELLOW}⊘${NC} $skill (already linked)"
            ((skipped++)) || true
        else
            echo -e "  ${YELLOW}⚠${NC} $skill exists but points elsewhere: $current_target"
            ((skipped++)) || true
        fi
    elif [[ -d "$target_path" ]]; then
        echo -e "  ${YELLOW}⚠${NC} $skill exists as directory (skipping)"
        ((skipped++))
    else
        ln -s "$source_path" "$target_path"
        echo -e "  ${GREEN}✓${NC} $skill"
        ((installed++)) || true
    fi
done

# Install agents
agents_installed=0
agents_skipped=0

if [[ -d "$AGENTS_SOURCE" ]]; then
    echo ""
    echo -e "${BLUE}Installing agents from $AGENTS_SOURCE${NC}"
    mkdir -p "$AGENTS_TARGET"

    for agent_file in "$AGENTS_SOURCE"/*.md; do
        [[ -f "$agent_file" ]] || continue
        agent_name="$(basename "$agent_file")"
        target_path="$AGENTS_TARGET/$agent_name"

        if [[ -L "$target_path" ]]; then
            current_target="$(readlink "$target_path")"
            if [[ "$current_target" == "$agent_file" ]]; then
                echo -e "  ${YELLOW}⊘${NC} $agent_name (already linked)"
                ((agents_skipped++)) || true
            else
                echo -e "  ${YELLOW}⚠${NC} $agent_name exists but points elsewhere: $current_target"
                ((agents_skipped++)) || true
            fi
        elif [[ -f "$target_path" ]]; then
            echo -e "  ${YELLOW}⚠${NC} $agent_name exists as file (skipping)"
            ((agents_skipped++)) || true
        else
            ln -s "$agent_file" "$target_path"
            echo -e "  ${GREEN}✓${NC} $agent_name"
            ((agents_installed++)) || true
        fi
    done
fi

echo ""
echo -e "${GREEN}Done!${NC} Skills: $installed installed, $skipped skipped. Agents: $agents_installed installed, $agents_skipped skipped."
echo ""
echo "Skills are now available in Claude Code. Try:"
echo "  /auto-build [task description]"
echo "  /deep-researching [topic]"
echo "  /building-skills"
echo "  /code-review"
echo "  /walkthrough"
echo "  /research"
