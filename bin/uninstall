#!/usr/bin/env bash
set -euo pipefail

# Skills Uninstaller
# Removes symlinks from ~/.claude/skills/ that point to this repo

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SKILLS_SOURCE="$SCRIPT_DIR/.claude/skills"
SKILLS_TARGET="$HOME/.claude/skills"
AGENTS_SOURCE="$SCRIPT_DIR/.claude/agents"
AGENTS_TARGET="$HOME/.claude/agents"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

CLAUDE_MD_SOURCE="$SCRIPT_DIR/CLAUDE.md"
CLAUDE_MD_TARGET="$HOME/.claude/CLAUDE.md"

echo "Uninstalling skills..."

# Remove CLAUDE.md symlink
if [[ -L "$CLAUDE_MD_TARGET" ]]; then
    current_target="$(readlink "$CLAUDE_MD_TARGET")"
    if [[ "$current_target" == "$CLAUDE_MD_SOURCE" ]]; then
        rm "$CLAUDE_MD_TARGET"
        echo -e "  ${RED}✗${NC} CLAUDE.md (removed)"
    else
        echo -e "  ${YELLOW}⊘${NC} CLAUDE.md (points elsewhere, skipping)"
    fi
else
    echo -e "  ${YELLOW}⊘${NC} CLAUDE.md (not installed)"
fi

skills=($(ls -d "$SKILLS_SOURCE"/*/ 2>/dev/null | xargs -n1 basename))

removed=0
skipped=0

for skill in "${skills[@]}"; do
    target_path="$SKILLS_TARGET/$skill"

    if [[ -L "$target_path" ]]; then
        current_target="$(readlink "$target_path")"
        if [[ "$current_target" == "$SKILLS_SOURCE/$skill" ]]; then
            rm "$target_path"
            echo -e "  ${RED}✗${NC} $skill (removed)"
            ((removed++)) || true
        else
            echo -e "  ${YELLOW}⊘${NC} $skill (points elsewhere, skipping)"
            ((skipped++)) || true
        fi
    else
        echo -e "  ${YELLOW}⊘${NC} $skill (not installed)"
        ((skipped++))
    fi
done

# Remove agent symlinks
agents_removed=0
agents_skipped=0

if [[ -d "$AGENTS_SOURCE" ]]; then
    echo ""
    echo "Uninstalling agents..."

    for agent_file in "$AGENTS_SOURCE"/*.md; do
        [[ -f "$agent_file" ]] || continue
        agent_name="$(basename "$agent_file")"
        target_path="$AGENTS_TARGET/$agent_name"

        if [[ -L "$target_path" ]]; then
            current_target="$(readlink "$target_path")"
            if [[ "$current_target" == "$agent_file" ]]; then
                rm "$target_path"
                echo -e "  ${RED}✗${NC} $agent_name (removed)"
                ((agents_removed++)) || true
            else
                echo -e "  ${YELLOW}⊘${NC} $agent_name (points elsewhere, skipping)"
                ((agents_skipped++)) || true
            fi
        else
            echo -e "  ${YELLOW}⊘${NC} $agent_name (not installed)"
            ((agents_skipped++)) || true
        fi
    done
fi

echo ""
echo -e "${GREEN}Done!${NC} Skills: $removed removed, $skipped skipped. Agents: $agents_removed removed, $agents_skipped skipped."
